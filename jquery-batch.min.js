/*
 * jquery-batch.js v0.1
 * Copyright 2012, Matt Morgan (@mlmorg)
 * May be freely distributed under the MIT license.
 */
(function(a){"use strict";var b=a.$;b.batchSettings={url:"/_bulk",type:"POST",contentType:"application/json",processData:!1,dataType:"text",serialize:function(a,b,c){return a},toJSON:function(a){return JSON.stringify(a)},parse:function(a){var c=[];return b.each(a.split("\n"),function(a,b){b&&(b=JSON.parse(b),b.body=JSON.parse(b.body),c.push(b))}),c}},b.batchSetup=function(a){return b.extend(b.batchSettings,a)};var c=b.batch=function(a,d){return this instanceof c?(typeof a=="object"&&(d=a,a=undefined),this.options=b.extend({},b.batchSettings,d),this.requests=[],a?this.add(a):this):new c(a,d)};b.extend(c.prototype,{add:function(a){return b.ajaxSettings._batch=this,a.call(this),delete b.ajaxSettings._batch,this},send:function(a){a=a||{};var c=this;if(this.requests.length){var d=b.map(this.requests,function(a,b){return a.request});a=b.extend({},this.options,a),a.data||(a.data=b.batchSettings.toJSON(d));var e=a.success;return a.success=function(a,b,d){c._deliver.call(c,a),e&&e(a,b,d)},b.ajax(a)}},_addRequest:function(a,c){var d={method:c.type,path:c.url,headers:{},body:c.data},e=this._extractParams(c.url);e&&(d.path=c.url.replace("?"+e,""),d.query=c.query?c.query:e),c.contentType&&(d.headers["content-type"]=c.contentType),c.headers&&b.each(c.headers,function(a,b){d.headers[a.toLowerCase()||a]=b}),d=b.batchSettings.serialize(d,a,c),this.requests.push({xhr:a,settings:c,request:d})},_deliver:function(a){var c=this,d=b.batchSettings.parse(a);b.each(d,function(a,b){if(!c.requests[a])return;var d=c.requests[a];d.xhr.status=b.status,d.xhr.statusText=c._statusText(b.status);var e=d.settings[d.xhr.statusText==="error"?"error":"success"];e&&e.call(d.xhr,b.body,d.xhr.statusText,d.xhr)})},_extractParams:function(a){var b=a.lastIndexOf("?");return b>=0?a.substr(b+1):null},_statusText:function(a){var b="error";if(a>=200&&a<300||a===304)a===304?b="notmodified":b="success";return b}});var d=b.ajax;b.ajax=function(a,b){typeof a=="object"&&(b=a,a=undefined),b=b||{};var c=b.beforeSend;return b.beforeSend=function(a,b){if(c){var d=c(a,b);if(d===!1)return d}if(b._batch)return b._batch._addRequest(a,b),!1},d.call(this,a,b)}})(this);