/*
 * jquery-batch.js v0.1
 * Copyright 2012, Matt Morgan (@mlmorg)
 * May be freely distributed under the MIT license.
 */
(function(a){"use strict";var b=a.$;b.batchSettings={url:"/_bulk",type:"POST",contentType:"application/json",processData:!1,dataType:"text"},b.batchSetup=function(a){return b.extend(b.batchSettings,a)};var c=b.batch=function(a,d){return this instanceof c?(typeof a=="object"&&(d=a,a=undefined),this.options=b.extend({},b.batchSettings,d),this.requests=[],a?this.add(a):this):new c(a,d)};b.extend(c.prototype,{add:function(a){return b.ajaxSettings._batch=this,a.call(this),delete b.ajaxSettings._batch,this},send:function(a){var c=this;if(this.requests.length){var d=b.map(this.requests,function(a,b){return a.request});b.extend(this.options,{data:JSON.stringify(d)},a);var e=this.options.success;return this.options.success=function(a,b,d){c._deliver.call(c,a,b,d),e&&e(a,b,d)},b.ajax(this.options)}},_addRequest:function(a,c){var d={xhr:a,settings:c,request:{method:c.type,path:c.url,headers:{},body:c.data}},e=this._extractParams(c.url);e&&(d.request.path=c.url.replace("?"+e,""),d.request.query=c.query?c.query:e),c.contentType&&(d.request.headers["content-type"]=c.contentType),c.headers&&b.each(c.headers,function(a,b){d.request.headers[a.toLowerCase()||a]=b}),this.requests.push(d)},_deliver:function(a,c,d){var e=this;b.each(a.split("\n"),function(a,b){if(!e.requests[a])return;var c=e.requests[a];b=JSON.parse(b),c.xhr.status=b.status,c.xhr.statusText=e._statusText(b.status);var d=c.settings[c.xhr.statusText==="error"?"error":"success"];d&&d.call(c.xhr,JSON.parse(b.body),c.xhr.statusText,c.xhr)})},_extractParams:function(a){var b=a.lastIndexOf("?");return b>=0?a.substr(b+1):null},_statusText:function(a){var b="error";if(a>=200&&a<300||a===304)a===304?b="notmodified":b="success";return b}});var d=b.ajax;b.ajax=function(a,b){typeof a=="object"&&(b=a,a=undefined),b=b||{};var c=b.beforeSend;return b.beforeSend=function(a,b){if(c){var d=c(a,b);if(d===!1)return d}if(b._batch)return b._batch._addRequest(a,b),!1},d.call(this,a,b)}})(this);